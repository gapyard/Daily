<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üìñ ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --line:#1f2937; --text:#e2e8f0; --muted:#94a3b8;
    --input:#0b1220; --btn:#1f2937; --primary:#2563eb; --danger:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px;display:grid;gap:16px}
  h1{margin:0 0 8px;text-align:center}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
  input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:var(--input);color:var(--text)}
  input[type="date"]{padding:9px}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{border:0;border-radius:9px;padding:9px 12px;background:var(--btn);color:var(--text);cursor:pointer}
  .btn.primary{background:var(--primary)}
  .btn.danger{background:var(--danger)}
  .btn.ghost{background:#1f2937;color:#e5e7eb;font-size:12px;padding:6px 8px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  /* timeline */
  #timeline{display:grid;gap:8px}
  .item{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;gap:10px}
  .left{flex:1;min-width:0}
  .title{font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px}
  .weekday{background:#1f2937;color:#9ca3af;border-radius:999px;padding:2px 8px;font-size:12px}
  .line{color:var(--text);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
  .thumbs{display:flex;gap:4px;margin-left:6px}
  .thumbs img{width:28px;height:28px;object-fit:cover;border-radius:6px;border:1px solid #374151;cursor:pointer}
  /* lightbox */
  .lb{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:50}
  .lb img{max-width:92vw;max-height:92vh;border-radius:10px;border:1px solid #334155}
  .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:22px;background:#1f2937;color:#e5e7f0;border:1px solid #334155;border-radius:8px;padding:6px 10px;cursor:pointer}
  .prev{left:14px} .next{right:14px}
  .close{top:14px;right:14px;transform:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>üìñ ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
        <div id="weekday" class="weekday" style="display:inline-block;margin-top:8px">‚Äî</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)</label>
        <input id="place" list="placeList" placeholder="‡πÄ‡∏ä‡πà‡∏ô The Mall, Central" autocomplete="off" />
        <datalist id="placeList"></datalist>
      </div>
      <div>
        <label for="place_note">‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏õ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)</label>
        <input id="place_note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô / ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á / ‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="food">‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</label>
        <input id="food" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡∏ä‡∏≤‡∏ô‡∏°" />
      </div>
      <div></div>
    </div>

    <div>
      <label for="notes">‡πÇ‡∏ô‡πâ‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</label>
      <textarea id="notes" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡πâ‡∏ï‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î..."></textarea>
    </div>

    <div class="row">
      <div>
        <label for="photos">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
        <input id="photos" type="file" accept="image/*" multiple />
      </div>
      <div>
        <label>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
        <div class="controls">
          <button class="btn primary" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button class="btn" id="loadBtn">‡πÇ‡∏´‡∏•‡∏î</button>
          <button class="btn danger" id="clearBtn">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;font-size:15px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
    <div id="timeline"></div>
  </div>
</div>

<!-- Lightbox -->
<div id="lb" class="lb" onclick="if(event.target.id==='lb') closeLB()">
  <button class="nav prev" onclick="navLB(-1)">&lt;</button>
  <img id="lbImg" src="" alt="">
  <button class="nav next" onclick="navLB(1)">&gt;</button>
  <button class="nav close" onclick="closeLB()">‡∏õ‡∏¥‡∏î</button>
</div>

<script>
/* === migrate diary -> dj_db & normalize dates === */
(function migrate(){
  try{
    if(!localStorage.getItem('dj_db') && localStorage.getItem('diary')){
      localStorage.setItem('dj_db', localStorage.getItem('diary'));
    }
    const raw = localStorage.getItem('dj_db'); if(!raw) return;
    const src = JSON.parse(raw), out = {};
    for(const k in src){
      let d = k;
      if(/\d{1,2}\/\d{1,2}\/\d{4}/.test(k)){
        const [a,b,c] = k.split('/');
        d = (a.length===4) ? `${a}-${b.padStart(2,'0')}-${c.padStart(2,'0')}`
                           : `${c}-${a.padStart(2,'0')}-${b.padStart(2,'0')}`;
      }
      out[d] = src[k];
    }
    localStorage.setItem('dj_db', JSON.stringify(out));
  }catch(e){}
})();

/* === helpers & db === */
const $ = id => document.getElementById(id);
const WEEK = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
const todayISO = () => new Date().toISOString().slice(0,10);
const readDB = () => { try{ return JSON.parse(localStorage.getItem('dj_db')||'{}'); }catch{return {}} };
const writeDB = (d) => localStorage.setItem('dj_db', JSON.stringify(d));

function updateWeekday(){ const d=new Date($('date').value); $('weekday').textContent = isNaN(d)?'‚Äî':WEEK[d.getDay()]; }

/* === images === */
function resize(file, maxW=1280, q=.85){
  return new Promise(resolve=>{
    const fr=new FileReader();
    fr.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        let w=img.width,h=img.height;
        if(w>maxW){ h=Math.round(h*(maxW/w)); w=maxW; }
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',q));
      }; img.src=e.target.result;
    }; fr.readAsDataURL(file);
  });
}

/* === CRUD === */
async function saveToday(){
  const d = readDB(); const key = $('date').value || todayISO();
  let photos = d[key]?.photos || [];
  const files = [...$('photos').files].slice(0,3);
  if(files.length){ photos=[]; for(const f of files) photos.push(await resize(f)); }

  d[key] = {
    place: $('place').value.trim(),
    place_note: $('place_note').value.trim(),
    food: $('food').value.trim(),
    notes: $('notes').value.trim(),
    photos
  };
  writeDB(d); renderTimeline(); buildPlaceHistory(); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì');
}
function loadToday(){
  const d = readDB(); const key = $('date').value || todayISO();
  const e = d[key] || {};
  $('place').value=e.place||''; $('place_note').value=e.place_note||'';
  $('food').value=e.food||''; $('notes').value=e.notes||'';
}
function clearToday(){
  const d=readDB(); const key=$('date').value||todayISO();
  if(!d[key]) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
  if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  delete d[key]; writeDB(d); renderTimeline(); buildPlaceHistory();
  $('place').value=$('place_note').value=$('food').value=$('notes').value='';
  $('photos').value='';
}

/* === place history (datalist) === */
function buildPlaceHistory(){
  const db = readDB();
  const vals = Object.values(db).map(e=>e?.place?.trim()).filter(Boolean);
  const freq={}; vals.forEach(v=>freq[v]=(freq[v]||0)+1);
  const uniq=[...new Set(vals)].sort((a,b)=>(freq[b]||0)-(freq[a]||0)||a.localeCompare(b));
  const dl=$('placeList'); dl.innerHTML='';
  uniq.slice(0,120).forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); });
}

/* === timeline (single line with emojis) === */
function renderTimeline(){
  const box=$('timeline'); box.innerHTML='';
  const d=readDB();
  const arr=Object.entries(d).map(([date,e])=>({date,...e})).sort((a,b)=>b.date.localeCompare(a.date));
  if(!arr.length){ box.innerHTML='<div style="color:#94a3b8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>'; return; }

  arr.forEach(it=>{
    const row=document.createElement('div'); row.className='item';

    const left=document.createElement('div'); left.className='left';
    const head=document.createElement('div'); head.className='title';
    head.innerHTML = `<span>${it.date}</span><span class="weekday">${WEEK[new Date(it.date).getDay()]}</span>`;
    const line=document.createElement('div'); line.className='line';
    line.textContent = [
      it.place?`üìç ${it.place}`:'',
      it.place_note?`üìù ${it.place_note}`:'',
      it.food?`üçö ${it.food}`:'',
      it.notes?`üóí ${it.notes.replace(/\s+/g,' ').trim()}`:''
    ].filter(Boolean).join('   ');
    left.appendChild(head); if(line.textContent) left.appendChild(line);

    const thumbs=document.createElement('div'); thumbs.className='thumbs';
    (it.photos||[]).forEach((src,i)=>{ const im=new Image(); im.src=src; im.onclick=()=>openLB(it.photos,i); thumbs.appendChild(im); });

    const act=document.createElement('div'); act.style.display='flex'; act.style.gap='6px';
    const b1=document.createElement('button'); b1.className='btn ghost'; b1.textContent='‡πÅ‡∏Å‡πâ';
    b1.onclick=()=>{$('date').value=it.date;updateWeekday();loadToday();scrollTo({top:0,behavior:'smooth'});};
    const b2=document.createElement('button'); b2.className='btn ghost'; b2.textContent='‡∏•‡∏ö';
    b2.onclick=()=>{ const d2=readDB(); if(confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${it.date}?`)){ delete d2[it.date]; writeDB(d2); renderTimeline(); buildPlaceHistory(); } };
    act.appendChild(b1); act.appendChild(b2);

    row.appendChild(left);
    if((it.photos||[]).length) row.appendChild(thumbs);
    row.appendChild(act);
    box.appendChild(row);
  });
}

/* === lightbox === */
let LB_ARR=[], LB_IDX=0;
function openLB(arr, i){ LB_ARR=arr||[]; LB_IDX=i||0; if(!LB_ARR.length) return; $('lbImg').src=LB_ARR[LB_IDX]; $('lb').style.display='flex'; }
function closeLB(){ $('lb').style.display='none'; }
function navLB(dir){ if(!LB_ARR.length) return; LB_IDX=(LB_IDX+dir+LB_ARR.length)%LB_ARR.length; $('lbImg').src=LB_ARR[LB_IDX]; }
document.addEventListener('keydown', e=>{ if($('lb').style.display==='flex'){ if(e.key==='Escape') closeLB(); if(e.key==='ArrowLeft') navLB(-1); if(e.key==='ArrowRight') navLB(1); }});

/* === boot === */
document.addEventListener('DOMContentLoaded', ()=>{
  $('date').value = todayISO();
  updateWeekday();
  $('date').addEventListener('change', updateWeekday);
  $('saveBtn').onclick=saveToday; $('loadBtn').onclick=loadToday; $('clearBtn').onclick=clearToday;
  renderTimeline(); buildPlaceHistory();
});
</script>
</body>
</html>
