<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",sans-serif;background:#0f172a;color:#e2e8f0}
    .container{max-width:900px;margin:0 auto;padding:20px;display:grid;gap:16px}
    h1{text-align:center;margin:0 0 12px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px}
    label{font-size:13px;color:#94a3b8;display:block;margin:10px 0 6px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e2e8f0}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .primary{background:#2563eb;color:#fff}
    .danger{background:#dc2626;color:#fff}
    .ghost{background:#1f2937;color:#e5e7eb;font-size:12px;padding:4px 8px}
    /* timeline */
    #timelineList{display:grid;gap:8px}
    .timeline-item{display:flex;align-items:center;gap:8px;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px}
    .timeline-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px}
    .thumbs{display:flex;gap:4px}
    .thumbs img{width:32px;height:32px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid #374151}
    .actions{display:flex;gap:4px}
    /* lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:50}
    .lightbox img{max-width:92vw;max-height:92vh;border-radius:10px;border:1px solid #334155}
    .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:22px;background:#1f2937;color:#e5e7f0;border:1px solid #334155;border-radius:8px;padding:6px 10px;cursor:pointer}
    .prev{left:14px} .next{right:14px}
    .close{top:14px;right:14px;transform:none}
  </style>
</head>
<body>
<div class="container">
  <h1>üìñ ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="date">
      </div>
      <div>
        <label>‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
        <div id="weekday" style="margin-top:10px;font-size:13px;color:#94a3b8">‚Äî</div>
      </div>
    </div>
    <div class="row">
      <div>
        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="place" list="placeList" placeholder="‡πÄ‡∏ä‡πà‡∏ô The Mall, Central" autocomplete="off">
        <datalist id="placeList"></datalist>
      </div>
      <div>
        <label>‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="place_note" placeholder="‡πÑ‡∏õ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô / ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á / ‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
      </div>
    </div>
    <div class="row">
      <div>
        <label>‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</label>
        <input id="food" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡∏ä‡∏≤‡∏ô‡∏°">
      </div>
      <div></div>
    </div>
    <div>
      <label>‡πÇ‡∏ô‡πâ‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</label>
      <textarea id="notes" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡πâ‡∏ï‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î..."></textarea>
    </div>
    <div>
      <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
      <input type="file" id="photosInput" accept="image/*" multiple>
      <div id="photosPreview" class="thumbs" style="margin-top:6px"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="primary" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button id="loadBtn">‡πÇ‡∏´‡∏•‡∏î</button>
      <button class="danger" id="clearBtn">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;font-size:15px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
    <div id="timelineList"></div>
  </div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="if(event.target.id==='lightbox') closeLB()">
  <button class="nav prev" onclick="navLB(-1)">&lt;</button>
  <img id="lightboxImg" src="">
  <button class="nav next" onclick="navLB(1)">&gt;</button>
  <button class="nav close" onclick="closeLB()">‡∏õ‡∏¥‡∏î</button>
</div>

<script>
/* ===== 0) Auto-migrate localStorage (diary -> dj_db + normalize dates) ===== */
(function migrateLocal(){
  try {
    // 0.1 copy diary -> dj_db if dj_db missing
    if (!localStorage.getItem('dj_db') && localStorage.getItem('diary')) {
      localStorage.setItem('dj_db', localStorage.getItem('diary'));
    }
    // 0.2 normalize date keys to YYYY-MM-DD
    const raw = localStorage.getItem('dj_db');
    if (raw) {
      const inDb = JSON.parse(raw), outDb = {};
      for (const k in inDb) {
        let d = k;
        if (/\d{1,2}\/\d{1,2}\/\d{4}/.test(k)) {
          const [a,b,c] = k.split('/');
          d = (a.length===4) ? `${a}-${b.padStart(2,'0')}-${c.padStart(2,'0')}` : `${c}-${a.padStart(2,'0')}-${b.padStart(2,'0')}`;
        }
        outDb[d] = inDb[k];
      }
      localStorage.setItem('dj_db', JSON.stringify(outDb));
    }
  } catch (e) {}
})();

/* ===== 1) Helpers & DB ===== */
const $ = id => document.getElementById(id);
const WEEK = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
const todayISO = () => new Date().toISOString().slice(0,10);

const readDB  = () => { try{ return JSON.parse(localStorage.getItem('dj_db')||'{}'); }catch{return {}} };
const writeDB = (d) => localStorage.setItem('dj_db', JSON.stringify(d));

function updateWeekday(){
  const d = new Date($('date').value);
  $('weekday').textContent = isNaN(d) ? '‚Äî' : WEEK[d.getDay()];
}

/* ===== 2) Images ===== */
function resize(file, maxW=1280, quality=0.85){
  return new Promise(resolve=>{
    const fr=new FileReader();
    fr.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        let w=img.width,h=img.height;
        if(w>maxW){ h=Math.round(h*(maxW/w)); w=maxW; }
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',quality));
      };
      img.src=e.target.result;
    };
    fr.readAsDataURL(file);
  });
}
function previewPhotos(arr){
  const box = $('photosPreview'); box.innerHTML = '';
  (arr||[]).forEach((src,i)=>{
    const im = new Image(); im.src = src; im.onclick = ()=>openLB(arr,i);
    box.appendChild(im);
  });
}

/* ===== 3) Place history ===== */
function refreshPlaceHistory(){
  const db = readDB();
  const vals = Object.values(db).map(e=>e?.place?.trim()).filter(Boolean);
  const freq = {}; vals.forEach(v=>freq[v]=(freq[v]||0)+1);
  const uniq = [...new Set(vals)].sort((a,b)=>(freq[b]||0)-(freq[a]||0) || a.localeCompare(b));
  const dl = $('placeList'); dl.innerHTML = '';
  uniq.slice(0,100).forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); });
}

/* ===== 4) CRUD ===== */
async function saveToday(){
  const d = readDB();
  const key = $('date').value || todayISO();
  const files = [...$('photosInput').files].slice(0,3);
  let photos = [];
  if(files.length){ for(const f of files) photos.push(await resize(f)); }
  else if (d[key]?.photos) { photos = d[key].photos; }

  d[key] = {
    place: $('place').value.trim(),
    place_note: $('place_note').value.trim(),
    food: $('food').value.trim(),
    notes: $('notes').value.trim(),
    photos
  };
  writeDB(d);
  renderTimeline();
  refreshPlaceHistory();
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì');
}

function loadToday(){
  const d = readDB();
  const key = $('date').value || todayISO();
  const e = d[key] || {};
  $('place').value = e.place || '';
  $('place_note').value = e.place_note || '';
  $('food').value = e.food || '';
  $('notes').value = e.notes || '';
  previewPhotos(e.photos || []);
}

function clearToday(){
  const d = readDB();
  const key = $('date').value || todayISO();
  if(!d[key]) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
  if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  delete d[key]; writeDB(d);
  $('place').value = $('place_note').value = $('food').value = $('notes').value = '';
  $('photosInput').value = ''; previewPhotos([]);
  renderTimeline(); refreshPlaceHistory();
}

/* ===== 5) Timeline (one-line + thumbnails + small actions right) ===== */
function oneLine(it){
  const w = WEEK[new Date(it.date).getDay()];
  const parts = [w, it.date, it.place||'', it.place_note||'', it.food||'', (it.notes||'').replace(/\s+/g,' ').trim()];
  return parts.filter(Boolean).join(' ');
}
function renderTimeline(){
  const list = $('timelineList'); list.innerHTML = '';
  const d = readDB();
  const arr = Object.entries(d).map(([date,e])=>({date, ...e})).sort((a,b)=>b.date.localeCompare(a.date));
  if(!arr.length){ list.innerHTML = '<div style="color:#94a3b8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>'; return; }

  arr.forEach(it=>{
    const row = document.createElement('div'); row.className = 'timeline-item';
    const text = document.createElement('div'); text.className = 'timeline-text'; text.textContent = oneLine(it);
    const thumbs = document.createElement('div'); thumbs.className = 'thumbs';
    (it.photos||[]).forEach((src,i)=>{ const im=new Image(); im.src=src; im.onclick=()=>openLB(it.photos,i); thumbs.appendChild(im);});
    const act = document.createElement('div'); act.className = 'actions';
    const edit = document.createElement('button'); edit.className='ghost'; edit.textContent='‡πÅ‡∏Å‡πâ'; edit.onclick=()=>{$('date').value=it.date;updateWeekday();loadToday();scrollTo({top:0,behavior:'smooth'});};
    const del = document.createElement('button'); del.className='ghost'; del.textContent='‡∏•‡∏ö'; del.onclick=()=>{const d2=readDB(); if(confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${it.date}?`)){ delete d2[it.date]; writeDB(d2); renderTimeline(); refreshPlaceHistory(); }};
    act.appendChild(edit); act.appendChild(del);
    row.appendChild(text); if((it.photos||[]).length) row.appendChild(thumbs); row.appendChild(act);
    list.appendChild(row);
  });
}

/* ===== 6) Lightbox ===== */
let LB_ARR = [], LB_IDX = 0;
function openLB(arr, i){ LB_ARR = arr||[]; LB_IDX = i||0; if(!LB_ARR.length) return; $('lightboxImg').src = LB_ARR[LB_IDX]; $('lightbox').style.display='flex'; }
function closeLB(){ $('lightbox').style.display='none'; }
function navLB(dir){ if(!LB_ARR.length) return; LB_IDX = (LB_IDX + dir + LB_ARR.length) % LB_ARR.length; $('lightboxImg').src = LB_ARR[LB_IDX]; }
document.addEventListener('keydown', e=>{ if($('lightbox').style.display==='flex'){ if(e.key==='Escape') closeLB(); if(e.key==='ArrowLeft') navLB(-1); if(e.key==='ArrowRight') navLB(1); }});

/* ===== 7) Boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  $('date').value = todayISO();
  updateWeekday();
  $('date').onchange = updateWeekday;
  $('saveBtn').onclick = saveToday;
  $('loadBtn').onclick = loadToday;
  $('clearBtn').onclick = clearToday;
  $('photosInput').onchange = async e=>{ const arr=[]; for(const f of [...e.target.files].slice(0,3)) arr.push(await resize(f)); previewPhotos(arr); };
  renderTimeline();
  refreshPlaceHistory();
});
</script>
</body>
</html>
