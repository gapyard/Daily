<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Journal ‚Äî No PIN</title>
  <link rel="manifest" href="manifest.webmanifest?v=v3">
  <meta name="theme-color" content="#111827">
  <style>
    :root{--bg:#0b1220;--card:#111827;--muted:#6b7280;--text:#e5e7eb;--accent:#10b981;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:#0d1628;position:sticky;top:0;z-index:5}
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .container{max-width:900px;margin:0 auto;padding:20px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], textarea, input[type="date"]{width:100%;padding:12px;border-radius:12px;border:1px solid #374151;background:#0d1628;color:var(--text);outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:10px 14px;background:#1f2937;color:var(--text);cursor:pointer}
    button.primary{background:var(--accent);color:#04110c}
    button.danger{background:var(--danger);color:#fff}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:10px;border:1px solid #374151}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;color:#9ca3af;font-size:12px}
    .spacer{height:8px}
    .history-list{position:absolute; z-index:40; left:0; right:0; background:#0f172a; border:1px solid #24304a; border-radius:10px; max-height:220px; overflow:auto; display:none; box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .history-item{padding:8px 12px; cursor:pointer; border-bottom:1px solid #1f2937}
    .history-item:hover{background:#111827}
    .banner{position:fixed;left:0;right:0;bottom:0;background:#111827;border-top:1px solid #24304a;padding:8px 12px;font-size:12px;color:#9ca3af;z-index:60}
  </style>
</head>
<body>
<header>
  <h1>üìî Daily Journal <span class="badge">v3 (no PIN)</span></h1>
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <div>
        <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
        <div id="weekday" class="badge">‚Äî</div>
      </div>
    </div>

    <div class="row">
      <div style="position:relative">
        <label for="place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="place" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô The Mall Bangkapi" autocomplete="off" />
        <div id="placeHistory" class="history-list"></div>
        <div class="muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ</div>
      </div>
      <div>
        <label for="placeNote">‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏õ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)</label>
        <input id="placeNote" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á / ‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="food">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</label>
        <input id="food" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡∏ä‡∏≤‡∏ô‡∏°" />
      </div>
      <div></div>
    </div>

    <div>
      <label for="notes">‡πÇ‡∏ô‡πâ‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</label>
      <textarea id="notes" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"></textarea>
    </div>

    <div class="row">
      <div>
        <label for="photos">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
        <input id="photos" type="file" accept="image/*" multiple />
        <div class="muted">‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
        <div id="thumbs" class="thumbs"></div>
      </div>
      <div>
        <label>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
        <div class="buttons">
          <button class="primary" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="loadBtn">‡πÇ‡∏´‡∏•‡∏î</button>
          <button id="clearBtn" class="danger">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
        <div class="spacer"></div>
        <div class="buttons">
          <button id="exportBtn">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON</button>
          <button id="importBtn">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>
  </div>
</div>

<div class="banner" id="banner" hidden>
  <span id="bannerText"></span>
</div>

<script>
// ===== Utilities =====
const $ = (id)=>document.getElementById(id);
function showBanner(msg){ const b=$('banner'); $('bannerText').textContent=msg; b.hidden=false; }

function todayISO(){ return new Date().toISOString().slice(0,10); }
const WEEKDAYS = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
function updateWeekday(dateStr){
  const d = new Date(dateStr);
  $('weekday').textContent = isNaN(d) ? '‚Äî' : WEEKDAYS[d.getDay()];
}
$('date').value = todayISO();
updateWeekday($('date').value);
$('date').addEventListener('change', e=>updateWeekday(e.target.value));

// Register new SW name to bust old cache
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker-nopin.js?v=v3').catch(()=>{});
}

// ===== Plain localStorage DB (no PIN) =====
function dbLoad(){
  try{
    const raw = localStorage.getItem('dj_db');
    return raw ? JSON.parse(raw) : {};
  }catch(e){ showBanner('‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà)'); return {}; }
}
function dbSave(db){
  try{
    localStorage.setItem('dj_db', JSON.stringify(db));
  }catch(e){ showBanner('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ'); }
}
let db = dbLoad();

// ===== Image resize =====
function loadImage(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>{ const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=reader.result; };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
async function resizeImageToDataURL(file, maxW=1280, quality=0.85){
  const img = await loadImage(file);
  let w = img.naturalWidth, h = img.naturalHeight;
  if(w > maxW){ h = Math.round(h * (maxW / w)); w = maxW; }
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
  return canvas.toDataURL('image/jpeg', quality);
}

// ===== UI =====
const inputs = { date:$('date'), place:$('place'), placeNote:$('placeNote'), food:$('food'), notes:$('notes') };
const thumbs = $('thumbs');
$('photos').addEventListener('change', async (e)=>{
  thumbs.innerHTML='';
  const files = [...e.target.files].slice(0,3);
  for(const f of files){ const dataURL = await resizeImageToDataURL(f, 1280, 0.85); const img = document.createElement('img'); img.src=dataURL; thumbs.appendChild(img); }
});
function gatherPhotosFromThumbs(){ return [...thumbs.querySelectorAll('img')].map(img=>img.src); }

function renderEntry(entry){
  inputs.place.value = entry?.place || '';
  inputs.placeNote.value = entry?.place_note || '';
  inputs.food.value  = entry?.food  || '';
  inputs.notes.value = entry?.notes || '';
  thumbs.innerHTML='';
  (entry?.photos||[]).forEach(src=>{ const img=document.createElement('img'); img.src=src; thumbs.appendChild(img); });
}

async function saveToday(){
  const d = inputs.date.value || todayISO();
  db[d] = {
    place: inputs.place.value.trim(),
    place_note: inputs.placeNote.value.trim(),
    food: inputs.food.value.trim(),
    notes: inputs.notes.value.trim(),
    photos: gatherPhotosFromThumbs()
  };
  dbSave(db);
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì');
}

async function loadToday(){
  const d = inputs.date.value || todayISO();
  renderEntry(db[d]);
}

async function clearToday(){
  const d = inputs.date.value || todayISO();
  if(!db[d]){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'); return; }
  if(confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){ delete db[d]; dbSave(db); renderEntry({}); }
}

$('saveBtn').onclick = saveToday;
$('loadBtn').onclick = loadToday;
$('clearBtn').onclick = clearToday;

$('exportBtn').onclick = ()=>{
  const payload = { version:2, plain:true, db };
  const a = document.createElement('a');
  const data = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  a.href = URL.createObjectURL(data); a.download = 'daily-journal-export.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('importBtn').onclick = ()=> $('importFile').click();
$('importFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const text = await file.text();
    const payload = JSON.parse(text);
    if(payload && payload.db && typeof payload.db==='object'){ db = payload.db; dbSave(db); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); renderEntry(db[$('date').value]); }
    else if (typeof payload === 'object') { db = payload; dbSave(db); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); renderEntry(db[$('date').value]); }
    else { alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
  }catch(err){ alert('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
});

// ===== Place History below input =====
function getPlaceHistory() {
  const vals = Object.values(db).map(e => (e && e.place ? e.place.trim() : '')).filter(Boolean);
  const freq = {};
  vals.forEach(v => freq[v] = (freq[v]||0)+1);
  const uniq = [...new Set(vals)];
  uniq.sort((a,b)=> (freq[b]||0)-(freq[a]||0) || a.localeCompare(b));
  return uniq;
}
const placeInput = $('place');
const placeHistBox = $('placeHistory');
function renderPlaceHistory(filter=''){
  const arr = getPlaceHistory().filter(v=>v.toLowerCase().includes(filter.toLowerCase()));
  placeHistBox.innerHTML='';
  if(!arr.length){ placeHistBox.style.display='none'; return; }
  arr.slice(0,30).forEach(txt=>{
    const div = document.createElement('div');
    div.className='history-item'; div.textContent = txt;
    div.onclick = ()=>{ placeInput.value = txt; placeHistBox.style.display='none'; };
    placeHistBox.appendChild(div);
  });
  placeHistBox.style.display='block';
}
placeInput.addEventListener('focus', ()=>renderPlaceHistory(placeInput.value));
placeInput.addEventListener('input', ()=>renderPlaceHistory(placeInput.value));
document.addEventListener('click', (e)=>{ if(e.target!==placeInput && !placeHistBox.contains(e.target)) placeHistBox.style.display='none'; });

// Load current date entry on start
loadToday();
</script>

</body>
</html>