<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e2e8f0;
      --line:#1f2937; --btn:#1f2937; --primary:#2563eb; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif}
    .container{max-width:900px;margin:0 auto;padding:20px;display:grid;gap:16px}
    h1{margin:0 0 6px 0;text-align:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:var(--text)}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:12px}
    .photos{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .photos img{width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid #374151}
    .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{border:0;border-radius:10px;padding:10px 14px;background:var(--btn);color:var(--text);cursor:pointer}
    button.primary{background:var(--primary);color:#fff}
    button.danger{background:var(--danger);color:#fff}
    /* Timeline */
    #timelineList{display:grid;gap:8px}
    .rowline{
      border:1px solid var(--line);border-radius:12px;background:#0b1220;padding:10px;display:grid;gap:6px
    }
    .rowline-head{display:flex;align-items:center;gap:10px}
    .badge{background:#1f2937;color:#9ca3af;border-radius:999px;padding:2px 8px;font-size:12px}
    .rowline-actions{margin-left:auto;display:flex;gap:6px}
    .btn-ghost{background:#1f2937; color:#e5e7eb; padding:6px 8px; border-radius:8px; font-size:12px}
    .inline-muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìñ ‡πÑ‡∏î‡∏≠‡∏≤‡∏£‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h1>

    <div class="card">
      <div class="row">
        <div>
          <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
          <div id="weekday" class="badge">‚Äî</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="place">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏î‡∏µ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ)</label>
          <input id="place" type="text" list="placeList" placeholder="‡πÄ‡∏ä‡πà‡∏ô The Mall, Central" autocomplete="off" />
          <datalist id="placeList"></datalist>
          <div class="muted">‡∏Ñ‡∏•‡∏¥‡∏Å/‡∏û‡∏¥‡∏°‡∏û‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏õ</div>
        </div>
        <div>
          <label for="place_note">‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏õ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)</label>
          <input id="place_note" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô / ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á / ‡πÄ‡∏à‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="food">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</label>
          <input id="food" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡∏ä‡∏≤‡∏ô‡∏°" />
        </div>
        <div></div>
      </div>

      <div>
        <label for="notes">‡πÇ‡∏ô‡πâ‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</label>
        <textarea id="notes" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."></textarea>
      </div>

      <div class="row">
        <div>
          <label for="photosInput">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
          <input id="photosInput" type="file" accept="image/*" multiple />
          <div class="muted">‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
          <div id="photosPreview" class="photos"></div>
        </div>
        <div>
          <label>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
          <div class="buttons">
            <button class="primary" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="loadBtn">‡πÇ‡∏´‡∏•‡∏î</button>
            <button class="danger" id="clearBtn">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          </div>
          <div class="buttons">
            <button id="exportBtn">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON</button>
            <button id="importBtn">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="card">
      <h3 style="margin:0 0 10px 0;font-size:16px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
      <div id="timelineList"></div>
    </div>
  </div>

<script>
/* ===== Config ===== */
const CLEAR_AFTER_SAVE = true; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô false ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å

/* ===== Helpers & DB ===== */
const $ = (id)=>document.getElementById(id);
const WEEKDAYS = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
const todayISO = ()=> new Date().toISOString().slice(0,10);
function toWeekday(iso){ const d=new Date(iso); return isNaN(d)?"‚Äî":WEEKDAYS[d.getDay()]; }

function readDB(){ try{ const raw=localStorage.getItem('dj_db'); return raw? JSON.parse(raw):{}; }catch{ return {}; } }
function writeDB(db){ localStorage.setItem('dj_db', JSON.stringify(db)); }

/* ===== Image handling ===== */
function resizeImage(file, maxW=1280, quality=0.85){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        let w=img.width, h=img.height;
        if(w>maxW){ h=Math.round(h*(maxW/w)); w=maxW; }
        const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ===== UI Bindings ===== */
function updateWeekday(){ $('weekday').textContent = toWeekday($('date').value); }
$('date').addEventListener('change', updateWeekday);

function renderPhotos(arr){
  const wrap=$('photosPreview'); wrap.innerHTML='';
  (arr||[]).forEach(src=>{ const img=document.createElement('img'); img.src=src; wrap.appendChild(img); });
}

/* ===== Place History (datalist) ===== */
function buildPlaceHistoryOptions(){
  const db=readDB();
  const vals = Object.values(db).map(e=>e?.place?.trim()).filter(Boolean);
  const freq={}; vals.forEach(v=>freq[v]=(freq[v]||0)+1);
  const uniq=[...new Set(vals)];
  uniq.sort((a,b)=>(freq[b]||0)-(freq[a]||0) || a.localeCompare(b));
  const dl=$('placeList'); dl.innerHTML='';
  uniq.slice(0,100).forEach(txt=>{
    const opt=document.createElement('option'); opt.value=txt; dl.appendChild(opt);
  });
}

/* ===== Save / Load / Clear ===== */
async function saveToday(){
  const db=readDB();
  const d=$('date').value || todayISO();
  const place=$('place').value.trim();
  const place_note=$('place_note').value.trim();
  const food=$('food').value.trim();
  const notes=$('notes').value.trim();

  // photos: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà -> ‡∏¢‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ -> ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
  let photos=[];
  const files=[...$('photosInput').files].slice(0,3);
  if(files.length){
    for(const f of files){ photos.push(await resizeImage(f)); }
  }else if(readDB()[d]?.photos){ photos = readDB()[d].photos; }

  db[d] = { place, place_note, food, notes, photos };
  writeDB(db);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ & ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
  renderTimeline();
  buildPlaceHistoryOptions();

  if (CLEAR_AFTER_SAVE) {
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
    $('place').value=''; $('place_note').value=''; $('food').value=''; $('notes').value='';
    $('photosInput').value=''; renderPhotos([]);
  } else {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ)
    loadToday();
  }
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì');
}

function loadToday(){
  const db=readDB();
  const d=$('date').value || todayISO();
  const e=db[d]||{};
  $('place').value=e.place||'';
  $('place_note').value=e.place_note||'';
  $('food').value=e.food||'';
  $('notes').value=e.notes||'';
  renderPhotos(e.photos||[]);
}

function clearToday(){
  const d=$('date').value || todayISO();
  const db=readDB();
  if(!db[d]){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'); return; }
  if(confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
    delete db[d]; writeDB(db);
    $('place').value=''; $('place_note').value=''; $('food').value=''; $('notes').value='';
    $('photosInput').value=''; renderPhotos([]);
    renderTimeline(); buildPlaceHistoryOptions();
  }
}

/* ===== Timeline (latest first) ===== */
function renderTimeline(){
  const list=$('timelineList');
  const db=readDB();
  const arr=Object.entries(db).map(([date,e])=>({date,...e}));
  arr.sort((a,b)=> b.date.localeCompare(a.date)); // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô

  if(!arr.length){ list.innerHTML='<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>'; return; }
  list.innerHTML='';
  arr.forEach(it=>{
    const row=document.createElement('div');
    row.className='rowline';

    const head=document.createElement('div');
    head.className='rowline-head';
    head.innerHTML=`<strong>${it.date}</strong><span class="badge">${toWeekday(it.date)}</span>`;

    const actions=document.createElement('div');
    actions.className='rowline-actions';
    const view=document.createElement('button'); view.className='btn-ghost'; view.textContent='‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π/‡πÅ‡∏Å‡πâ';
    view.onclick=()=>{ $('date').value=it.date; updateWeekday(); loadToday(); window.scrollTo({top:0,behavior:'smooth'}); };
    const del=document.createElement('button'); del.className='btn-ghost'; del.textContent='‡∏•‡∏ö';
    del.onclick=()=>{ const db=readDB(); if(confirm(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${it.date}?`)){ delete db[it.date]; writeDB(db); renderTimeline(); buildPlaceHistoryOptions(); } };
    actions.appendChild(view); actions.appendChild(del);
    head.appendChild(actions);

    const line=document.createElement('div');
    line.className='inline-muted';
    const parts=[];
    if(it.place) parts.push(`üìç ${it.place}`);
    if(it.place_note) parts.push(`üìù ${it.place_note}`);
    if(it.food) parts.push(`üçö ${it.food}`);
    line.textContent=parts.join('   ‚Ä¢   ');

    const notes=document.createElement('div');
    if(it.notes){ notes.textContent=it.notes; notes.style.whiteSpace='pre-wrap'; }

    const pics=document.createElement('div'); pics.className='photos';
    (it.photos||[]).forEach(src=>{ const img=document.createElement('img'); img.src=src; pics.appendChild(img); });

    row.appendChild(head);
    if(parts.length) row.appendChild(line);
    if(it.notes) row.appendChild(notes);
    if((it.photos||[]).length) row.appendChild(pics);
    list.appendChild(row);
  });
}

/* ===== Export/Import ===== */
$('exportBtn').onclick = ()=>{
  const payload = { version:3, plain:true, db: readDB() };
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  a.download='daily-journal-export.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('importBtn').onclick = ()=> $('importFile').click();
$('importFile').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const text=await file.text(); const payload=JSON.parse(text);
    const db = payload?.db && typeof payload.db==='object' ? payload.db : payload;
    if(db && typeof db==='object'){ writeDB(db); loadToday(); renderTimeline(); buildPlaceHistoryOptions(); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì'); }
    else alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }catch{ alert('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
});

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  $('date').value = todayISO();
  updateWeekday();
  loadToday();
  renderTimeline();
  buildPlaceHistoryOptions();
  $('saveBtn').onclick=saveToday;
  $('loadBtn').onclick=loadToday;
  $('clearBtn').onclick=clearToday;
});
</script>
</body>
</html>
