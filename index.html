<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Journal ‚Äî PIN Lock</title>
  <link rel="manifest" href="manifest.webmanifest?v=2.1">
  <meta name="theme-color" content="#111827">
  <style>
    :root{--bg:#0b1220;--card:#111827;--muted:#6b7280;--text:#e5e7eb;--accent:#10b981;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:#0d1628;position:sticky;top:0;z-index:5}
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .container{max-width:900px;margin:0 auto;padding:20px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], textarea, input[type="date"]{width:100%;padding:12px;border-radius:12px;border:1px solid #374151;background:#0d1628;color:var(--text);outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:10px 14px;background:#1f2937;color:var(--text);cursor:pointer}
    button.primary{background:var(--accent);color:#04110c}
    button.danger{background:var(--danger);color:#fff}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:10px;border:1px solid #374151}
    .muted{color:var(--muted);font-size:12px}
    .pin-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:50}
    .pin-modal{width:min(420px,92vw);background:#0f172a;border:1px solid #24304a;border-radius:18px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .pin-modal h2{margin:6px 0 12px 0;font-size:18px}
    .pin-grid{display:grid;gap:10px}
    .pin-grid input{font-size:20px;letter-spacing:6px;text-align:center;padding:12px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:var(--text)}
    .pin-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;color:#9ca3af;font-size:12px}
    .ok{color:#10b981}
    .err{color:#ef4444}
    .spacer{height:8px}
    .banner{position:fixed;left:0;right:0;bottom:0;background:#111827;border-top:1px solid #24304a;padding:8px 12px;font-size:12px;color:#9ca3af;z-index:60}
  </style>
</head>
<body>
<header>
  <h1>üìî Daily Journal <span class="badge">v2.1</span></h1>
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <div>
        <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
        <div id="weekday" class="badge">‚Äî</div>
      </div>
    </div>
    <div class="row">
      <div>
        <label for="place">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô</label>
        <input id="place" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô The Mall Bangkapi" />
      </div>
      <div>
        <label for="food">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£</label>
        <input id="food" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö ‡∏ä‡∏≤‡∏ô‡∏°" />
      </div>
    </div>
    <div>
      <label for="notes">‡πÇ‡∏ô‡πâ‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</label>
      <textarea id="notes" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"></textarea>
    </div>

    <div class="row">
      <div>
        <label for="photos">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
        <input id="photos" type="file" accept="image/*" multiple />
        <div class="muted">‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
        <div id="thumbs" class="thumbs"></div>
      </div>
      <div>
        <label>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
        <div class="buttons">
          <button class="primary" id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="loadBtn">‡πÇ‡∏´‡∏•‡∏î</button>
          <button id="clearBtn" class="danger">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
        <div class="spacer"></div>
        <div class="buttons">
          <button id="exportBtn">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON</button>
          <button id="importBtn">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
        <div class="spacer"></div>
        <div class="buttons">
          <button id="changePinBtn">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN</button>
          <button id="logoutBtn">‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå</button>
        </div>
        <p class="muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ PIN</p>
      </div>
    </div>
  </div>
</div>

<!-- PIN LOCK MODAL -->
<div class="pin-backdrop" id="pinBackdrop" hidden>
  <div class="pin-modal">
    <h2 id="pinTitle">‡∏ï‡∏±‡πâ‡∏á PIN 4 ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
    <div class="pin-grid">
      <input id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="pin-actions">
        <button class="primary" id="pinOk">‡∏ï‡∏Å‡∏•‡∏á</button>
        <button id="pinForgot">‡∏•‡∏∑‡∏° PIN</button>
      </div>
      <div id="pinHint" class="muted"></div>
    </div>
  </div>
</div>

<div class="banner" id="banner" hidden>
  <span id="bannerText"></span>
</div>

<script>
const $ = (id)=>document.getElementById(id);
function showBanner(msg){ const b=$('banner'); $('bannerText').textContent=msg; b.hidden=false; }

function todayISO(){ return new Date().toISOString().slice(0,10); }
const WEEKDAYS = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
function updateWeekday(dateStr){
  const d = new Date(dateStr);
  $('weekday').textContent = isNaN(d) ? '‚Äî' : WEEKDAYS[d.getDay()];
}
$('date').value = todayISO();
updateWeekday($('date').value);
$('date').addEventListener('change', e=>updateWeekday(e.target.value));

// Register SW for offline (ignore failures)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker-v21.js').catch(()=>{});
}

// ---- Storage sanity ----
function lsGet(k){ try{return localStorage.getItem(k);}catch(e){showBanner('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Storage)'); return null;} }
function lsSet(k,v){ try{localStorage.setItem(k,v);}catch(e){showBanner('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ'); throw e;} }
function lsDel(k){ try{localStorage.removeItem(k);}catch(e){} }

// ---- Crypto helpers ----
async function hash(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return btoa(String.fromCharCode(...new Uint8Array(buf)));
}
function b64ToBytes(b64){ const bin = atob(b64); const bytes = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return bytes; }
function bytesToB64(bytes){ let bin=''; bytes=new Uint8Array(bytes); for(let i=0;i<bytes.length;i++) bin+=String.fromCharCode(bytes[i]); return btoa(bin); }
async function deriveKey(pin, saltB64){
  const salt = b64ToBytes(saltB64);
  const keyMat = await crypto.subtle.importKey('raw', new TextEncoder().encode(pin), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'},
    keyMat,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
}
async function encryptJSON(key, obj){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
  return { iv: bytesToB64(iv), blob: bytesToB64(new Uint8Array(cipher)) };
}
async function decryptJSON(key, ivB64, b64){
  const iv = b64ToBytes(ivB64);
  const data = b64ToBytes(b64);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data);
  return JSON.parse(new TextDecoder().decode(plain));
}

// ---- DB ----
let key; let db={};

// ---- PIN gate ----
const pinBackdrop = $('pinBackdrop');
const pinInput = $('pinInput');
const pinTitle = $('pinTitle');
const pinHint = $('pinHint');

function openPinModal(title){
  pinTitle.textContent = title;
  pinBackdrop.hidden = false;
  setTimeout(()=>pinInput.focus(), 0);
}

async function ensurePinThenUnlock(){
  try{
    const pinHash = lsGet('dj_pin_hash');
    if(!pinHash){
      // First-time: set new PIN
      openPinModal('‡∏ï‡∏±‡πâ‡∏á PIN 4 ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      return new Promise((resolve)=>{
        $('pinOk').onclick = async ()=>{
          const pin = pinInput.value.trim();
          if(!/^[0-9]{4}$/.test(pin)){ pinHint.innerHTML='<span class="err">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà PIN 4 ‡∏´‡∏•‡∏±‡∏Å</span>'; return; }
          const salt = bytesToB64(crypto.getRandomValues(new Uint8Array(16)));
          const ph = await hash('v1:'+pin+':'+salt);
          lsSet('dj_pin_hash', ph);
          lsSet('dj_salt', salt);
          key = await deriveKey(pin, salt);
          db = {};
          const enc = await encryptJSON(key, db);
          lsSet('dj_iv', enc.iv);
          lsSet('dj_blob', enc.blob);
          pinBackdrop.hidden = true;
          resolve();
        };
        $('pinForgot').onclick = ()=> pinHint.innerHTML = '<span class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á PIN</span>';
        pinInput.onkeydown = (e)=>{ if(e.key==='Enter') $('pinOk').click(); };
      });
    } else {
      // Unlock
      openPinModal('‡∏Å‡∏£‡∏≠‡∏Å PIN 4 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      return new Promise((resolve)=>{
        $('pinOk').onclick = async ()=>{
          const pin = pinInput.value.trim();
          if(!/^[0-9]{4}$/.test(pin)){ pinHint.innerHTML='<span class="err">PIN ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 4 ‡∏´‡∏•‡∏±‡∏Å</span>'; return; }
          const salt = lsGet('dj_salt');
          const ph = await hash('v1:'+pin+':'+salt);
          if(ph !== lsGet('dj_pin_hash')){ pinHint.innerHTML='<span class="err">PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>'; return; }
          key = await deriveKey(pin, salt);
          try{ db = await decryptJSON(key, lsGet('dj_iv'), lsGet('dj_blob')); }
          catch(e){ pinHint.innerHTML='<span class="err">‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢)</span>'; return; }
          pinBackdrop.hidden = true;
          resolve();
        };
        $('pinForgot').onclick = ()=>{
          if(confirm('‡∏•‡∏∑‡∏° PIN?\n‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏¢‡∏π‡πà. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){ ['dj_pin_hash','dj_salt','dj_iv','dj_blob'].forEach(lsDel); location.reload(); }
        };
        pinInput.onkeydown = (e)=>{ if(e.key==='Enter') $('pinOk').click(); };
      });
    }
  }catch(err){
    console.error(err);
    showBanner('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏±‡∏ö PIN/‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™: '+(err && err.message ? err.message : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
    throw err;
  }
}

// ---- Images ----
function loadImage(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>{ const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=reader.result; };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
async function resizeImageToDataURL(file, maxW=1280, quality=0.85){
  const img = await loadImage(file);
  let w = img.naturalWidth, h = img.naturalHeight;
  if(w > maxW){ h = Math.round(h * (maxW / w)); w = maxW; }
  const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
  return canvas.toDataURL('image/jpeg', quality);
}

// ---- UI ----
const inputs = { date:$('date'), place:$('place'), food:$('food'), notes:$('notes') };
const thumbs = $('thumbs');
$('photos').addEventListener('change', async (e)=>{
  thumbs.innerHTML='';
  const files = [...e.target.files].slice(0,3);
  for(const f of files){ const dataURL = await resizeImageToDataURL(f, 1280, 0.85); const img = document.createElement('img'); img.src=dataURL; thumbs.appendChild(img); }
});
function gatherPhotosFromThumbs(){ return [...thumbs.querySelectorAll('img')].map(img=>img.src); }

async function encryptAndPersist(){
  const enc = await encryptJSON(key, db);
  lsSet('dj_iv', enc.iv);
  lsSet('dj_blob', enc.blob);
}

async function saveToday(){
  const d = inputs.date.value || todayISO();
  db[d] = {
    place: inputs.place.value.trim(),
    food: inputs.food.value.trim(),
    notes: inputs.notes.value.trim(),
    photos: gatherPhotosFromThumbs()
  };
  await encryptAndPersist();
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì');
}

function renderEntry(entry){
  inputs.place.value = entry?.place || '';
  inputs.food.value  = entry?.food  || '';
  inputs.notes.value = entry?.notes || '';
  thumbs.innerHTML='';
  (entry?.photos||[]).forEach(src=>{ const img=document.createElement('img'); img.src=src; thumbs.appendChild(img); });
}

async function loadToday(){
  const d = inputs.date.value || todayISO();
  renderEntry(db[d]);
}

async function clearToday(){
  const d = inputs.date.value || todayISO();
  if(!db[d]){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'); return; }
  if(confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){ delete db[d]; await encryptAndPersist(); renderEntry({}); }
}

$('saveBtn').onclick = saveToday;
$('loadBtn').onclick = loadToday;
$('clearBtn').onclick = clearToday;

$('exportBtn').onclick = ()=>{
  const payload = { version:1, iv: lsGet('dj_iv'), salt: lsGet('dj_salt'), blob: lsGet('dj_blob') };
  const a = document.createElement('a');
  const data = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  a.href = URL.createObjectURL(data); a.download = 'daily-journal-export.json'; a.click(); URL.revokeObjectURL(a.href);
};

$('importBtn').onclick = ()=> $('importFile').click();
$('importFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const text = await file.text();
    const payload = JSON.parse(text);
    if(!payload.iv || !payload.salt || !payload.blob) return alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    if(!confirm('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏´‡∏°?')) return;
    lsSet('dj_iv', payload.iv); lsSet('dj_salt', payload.salt); lsSet('dj_blob', payload.blob);
    ['dj_pin_hash'].forEach(lsDel);
    alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    location.reload();
  }catch(err){ alert('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
});

$('changePinBtn').onclick = async ()=>{
  const old = prompt('‡πÉ‡∏™‡πà PIN ‡πÄ‡∏î‡∏¥‡∏° (4 ‡∏´‡∏•‡∏±‡∏Å):'); if(!old) return;
  const salt = lsGet('dj_salt');
  const ph = await hash('v1:'+old+':'+salt);
  if(ph !== lsGet('dj_pin_hash')) return alert('PIN ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  const n1 = prompt('‡∏ï‡∏±‡πâ‡∏á PIN ‡πÉ‡∏´‡∏°‡πà (4 ‡∏´‡∏•‡∏±‡∏Å):'); if(!n1 || !/^[0-9]{4}$/.test(n1)) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å');
  const n2 = prompt('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô PIN ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á:'); if(n1!==n2) return alert('‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
  const newSalt = bytesToB64(crypto.getRandomValues(new Uint8Array(16)));
  const newKey = await deriveKey(n1, newSalt);
  const enc = await encryptJSON(newKey, db);
  lsSet('dj_salt', newSalt); lsSet('dj_iv', enc.iv); lsSet('dj_blob', enc.blob);
  lsSet('dj_pin_hash', await hash('v1:'+n1+':'+newSalt));
  key = newKey; alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
};

$('logoutBtn').onclick = ()=>{ alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); location.reload(); };

ensurePinThenUnlock().then(()=>{ $('notes').placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; }).catch(()=>{});
</script>

</body>
</html>